<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMR Patient Notes</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS library for reading spreadsheet data -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Source Sans Pro', sans-serif;
            background-color: #f0f2f5;
        }
        .active-note {
            background-color: #e6f7ff;
            border-left-color: #1890ff;
        }
        /* Custom scrollbar for a more modern look */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .soap-section h4 {
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.25rem;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%236b7280' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="flex h-screen bg-gray-100">
        <!-- Left Panel: Patient Notes List -->
        <aside class="w-1/3 xl:w-1/4 h-full flex flex-col bg-white border-r border-gray-200">
            <header class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h1 class="text-xl font-bold text-gray-700">Patient Encounters</h1>
                <i class="fas fa-notes-medical text-blue-600 text-2xl"></i>
            </header>
            
            <!-- Filters Section -->
            <div id="filters" class="p-3 border-b border-gray-200 space-y-3">
                <input type="text" id="searchInput" placeholder="Search patient or complaint..." class="w-full p-2 bg-gray-50 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <select id="gameFilter" class="w-full p-2 bg-gray-50 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="">All Games</option>
                </select>
                <select id="icdFilter" class="w-full p-2 bg-gray-50 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="">All ICD-10 Codes</option>
                </select>
            </div>

            <div id="noteList" class="flex-grow overflow-y-auto">
                <!-- Notes will be inserted here -->
                 <div id="loader" class="flex justify-center items-center h-full">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
                </div>
            </div>
        </aside>

        <!-- Right Panel: Note Details -->
        <main id="noteDetail" class="w-2/3 xl:w-3/4 h-full flex flex-col">
            <header class="bg-white p-4 border-b border-gray-200 flex justify-between items-center">
                 <h2 id="patientName" class="text-2xl font-bold text-gray-800">Select a Patient Note</h2>
                 <div id="patientInfo" class="text-right text-sm text-gray-500">
                    <!-- Patient details like Age and Game will go here -->
                 </div>
            </header>
            <div id="noteContent" class="flex-grow overflow-y-auto p-6 bg-gray-50">
                <div id="placeholder" class="h-full flex flex-col justify-center items-center text-gray-400">
                    <i class="fas fa-file-alt text-6xl mb-4"></i>
                    <p class="text-xl">Select a patient note from the list to view details.</p>
                </div>
                <div id="details-container" class="hidden">
                    <!-- SOAP notes will be dynamically inserted here -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-blue-700">Chief Complaint</h3>
                            <p id="detail-complaint" class="text-xl text-gray-900"></p>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="soap-section">
                                <h4>Subjective</h4>
                                <p id="detail-subjective"></p>
                            </div>
                            <div class="soap-section">
                                <h4>Objective</h4>
                                <p id="detail-objective"></p>
                            </div>
                            <div class="soap-section col-span-1 lg:col-span-2">
                                <h4>Assessment / Plan</h4>
                                <p id="detail-assessment"></p>
                            </div>
                             <div class="soap-section col-span-1 lg:col-span-2">
                                <h4>Recovery / Follow-Up</h4>
                                <p id="detail-recovery"></p>
                            </div>
                        </div>
                         <div class="mt-6 pt-4 border-t border-gray-200">
                            <h4 class="font-bold text-gray-600 mb-2">Additional Information</h4>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><strong>ICD-10 Code:</strong> <span id="detail-icd10"></span></p>
                                <p><strong>Setting:</strong> <span id="detail-setting"></span></p>
                                <p><strong>Treatment Accuracy:</strong> <span id="detail-treatment-accuracy"></span></p>
                                <p><strong>Recovery Accuracy:</strong> <span id="detail-recovery-accuracy"></span></p>
                                <p><strong>Explanation:</strong> <span id="detail-explanation"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const loader = document.getElementById('loader');
            const noteList = document.getElementById('noteList');
            const searchInput = document.getElementById('searchInput');
            const gameFilter = document.getElementById('gameFilter');
            const icdFilter = document.getElementById('icdFilter');
            const patientName = document.getElementById('patientName');
            const patientInfo = document.getElementById('patientInfo');
            const placeholder = document.getElementById('placeholder');
            const detailsContainer = document.getElementById('details-container');

            // Detail fields
            const detailComplaint = document.getElementById('detail-complaint');
            const detailSubjective = document.getElementById('detail-subjective');
            const detailObjective = document.getElementById('detail-objective');
            const detailAssessment = document.getElementById('detail-assessment');
            const detailRecovery = document.getElementById('detail-recovery');
            const detailIcd10 = document.getElementById('detail-icd10');
            const detailSetting = document.getElementById('detail-setting');
            const detailTreatmentAccuracy = document.getElementById('detail-treatment-accuracy');
            const detailRecoveryAccuracy = document.getElementById('detail-recovery-accuracy');
            const detailExplanation = document.getElementById('detail-explanation');


            const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQntM4gqqcetDRtlNI_GPGopx-HfalfC0efux_-KhllcUUStVeeoUYF7SutJdeC-zWbeVn7Vpxkka4R/pub?output=xlsx';
            let allNotes = [];
            let activeNoteElement = null;

            async function loadData() {
                try {
                    const response = await fetch(sheetUrl);
                    const arrayBuffer = await response.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'buffer' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    allNotes = jsonData;
                    populateFilters(allNotes);
                    displayNotes(allNotes);

                } catch (error) {
                    console.error("Error loading spreadsheet data:", error);
                    noteList.innerHTML = `<p class="p-4 text-red-600">Failed to load patient data.</p>`;
                } finally {
                    loader.style.display = 'none';
                }
            }

            function populateFilters(notes) {
                const games = [...new Set(notes.map(note => note['Game']).filter(Boolean))].sort();
                const icdCodes = [...new Set(notes.map(note => note['ICD-10']).filter(Boolean))].sort();

                games.forEach(game => {
                    const option = new Option(game, game);
                    gameFilter.add(option);
                });

                icdCodes.forEach(code => {
                    const option = new Option(code, code);
                    icdFilter.add(option);
                });
            }

            function displayNotes(notes) {
                noteList.innerHTML = '';
                if (notes.length === 0) {
                    noteList.innerHTML = `<p class="p-4 text-gray-500 text-center">No patient notes match the current filters.</p>`;
                }

                notes.forEach((note, index) => {
                    const card = document.createElement('div');
                    card.className = 'p-4 border-b border-l-4 border-transparent cursor-pointer hover:bg-blue-50 transition-colors duration-150';
                    // Use a unique ID from the data if available, otherwise use index
                    card.dataset.noteId = note['IGDB ID'] || index;

                    const character = note['Character'] || 'Unknown Patient';
                    const complaint = note['Chief Complaint'] || 'No complaint';
                    const game = note['Game'] || 'N/A';

                    card.innerHTML = `
                        <h4 class="font-bold text-blue-800 truncate">${character}</h4>
                        <p class="text-sm text-gray-600 truncate">${complaint}</p>
                        <p class="text-xs text-gray-400 mt-1">${game}</p>
                    `;

                    card.addEventListener('click', () => {
                        showNoteDetails(note);
                        if (activeNoteElement) {
                            activeNoteElement.classList.remove('active-note');
                        }
                        card.classList.add('active-note');
                        activeNoteElement = card;
                    });
                    noteList.appendChild(card);
                });
            }

            function showNoteDetails(note) {
                placeholder.style.display = 'none';
                detailsContainer.style.display = 'block';

                patientName.textContent = note['Character'] || 'Unknown Patient';
                patientInfo.innerHTML = `
                    <span><strong>Age:</strong> ${note['Age'] || 'N/A'}</span>
                    <span class="ml-4"><strong>Game:</strong> ${note['Game'] || 'N/A'}</span>
                `;

                detailComplaint.textContent = note['Chief Complaint'] || 'N/A';
                detailSubjective.textContent = note['Subjective'] || 'N/A';
                detailObjective.textContent = note['Objective'] || 'N/A';
                detailAssessment.textContent = note['Assessment/ Plan'] || 'N/A';
                detailRecovery.textContent = note['Recovery/ Follow-Up/ Effect of Treatment'] || 'N/A';
                detailIcd10.textContent = note['ICD-10'] || 'N/A';
                detailSetting.textContent = note['Setting'] || 'N/A';
                detailTreatmentAccuracy.textContent = note['Treatment Accuracy'] || 'N/A';
                detailRecoveryAccuracy.textContent = note['Recovery Accuracy'] || 'N/A';
                detailExplanation.textContent = note['Explanation'] || 'N/A';
            }

            function applyFilters() {
                const searchQuery = searchInput.value.toLowerCase();
                const selectedGame = gameFilter.value;
                const selectedIcd = icdFilter.value;

                let filteredNotes = allNotes;

                // Filter by search query
                if (searchQuery) {
                    filteredNotes = filteredNotes.filter(note => 
                        Object.values(note).some(value => 
                            String(value).toLowerCase().includes(searchQuery)
                        )
                    );
                }

                // Filter by selected game
                if (selectedGame) {
                    filteredNotes = filteredNotes.filter(note => note['Game'] === selectedGame);
                }

                // Filter by selected ICD-10 code
                if (selectedIcd) {
                    filteredNotes = filteredNotes.filter(note => note['ICD-10'] === selectedIcd);
                }

                displayNotes(filteredNotes);
            }
            
            searchInput.addEventListener('input', applyFilters);
            gameFilter.addEventListener('change', applyFilters);
            icdFilter.addEventListener('change', applyFilters);

            loadData();
        });
    </script>

</body>
</html>
